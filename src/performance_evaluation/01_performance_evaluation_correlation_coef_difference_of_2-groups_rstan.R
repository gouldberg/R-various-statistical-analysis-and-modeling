setwd("//media//kswada//MyFiles//R//performance_evaluation//")

packages <- c("dplyr", "rstan")
purrr::walk(packages, library, character.only = TRUE, warn.conflicts = FALSE)


# ------------------------------------------------------------------------------
# data:  performance_evaluation
#   - 人事評価の一環として、社員に自身の仕事ぶりについての自己評価と、上司からの評価を求めている
#     人事担当者は日頃より、他社から転職してきた社員群と、自社の生え抜き社員群では自己・上司評価間の安定度が異なり、
#     転職群の方が2者の評価傾向が安定していると感じている
#     そこで、自己評価と上司評価の安定度の効果量として相関係数を推定し、2群間の相関係数の差について検討することとした
#        - 転職群の方が、2者間の評価傾向が安定していると言えるか　（相関係数が高いと言えるか）
#        - 2群の相関係数の差がプラスの確率は？
# ------------------------------------------------------------------------------
N <- 200
xA <- structure(.Data=c(
  11,6,10,8,10,14,5,9,15,10,8,8,14,10,11,8,12,11,12,9,6,10,12,11,8,10,8,9,7,5,8,10,14,15,5,11,5,7,5,11,10,9,14,11,10,11,13,10,15,15,15,5,8,16,6,11,9,10,9,16,13,9,10,17,8,7,14,9,9,12,7,17,15,13,9,10,11,5,4,9,11,11,3,12,14,12,9,8,9,12,9,13,15,11,14,11,7,15,13,11,10,14,2,11,14,12,12,9,11,10,13,12,8,6,10,11,10,11,13,9,9,12,13,9,12,11,11,13,13,10,17,8,11,8,9,13,6,17,9,14,11,10,7,13,13,8,9,9,7,9,8,11,14,9,8,10,8,8,2,8,5,9,10,8,17,7,11,8,10,7,8,12,9,11,6,11,5,12,9,7,14,9,10,7,5,12,6,11,10,9,6,7,11,4,12,9,14,9,4,12,
  12,10,12,10,10,14,9,11,14,9,9,9,13,13,13,10,13,10,13,11,10,11,10,12,9,8,10,11,12,8,11,6,9,12,9,15,10,11,10,15,12,11,12,12,13,10,13,9,14,13,14,6,11,14,8,10,9,8,10,12,12,8,13,15,9,9,13,13,7,14,5,14,13,12,13,12,12,10,8,12,12,13,9,11,10,13,13,11,10,10,8,13,13,9,12,14,7,14,11,10,13,15,9,10,14,11,11,11,12,10,12,15,13,12,13,11,10,11,14,11,9,14,15,9,9,10,13,13,15,14,14,9,11,11,11,13,10,13,9,13,11,13,10,12,13,8,9,12,11,10,12,13,12,11,11,12,9,11,9,9,11,9,10,11,13,10,12,8,9,9,12,10,12,9,10,12,8,11,9,9,13,9,10,10,9,11,8,13,9,12,10,9,9,6,12,10,12,8,10,12
),.Dim=c(N,2))

xB <- structure(.Data=c(
  16,12,13,15,10,16,10,12,12,16,15,15,14,13,9,12,10,10,16,15,12,15,13,15,12,15,11,14,17,13,9,14,13,14,8,10,8,10,12,12,17,11,10,12,7,11,8,13,10,7,7,11,13,11,12,9,16,10,8,10,10,10,12,15,9,9,13,10,15,12,15,14,12,13,11,13,13,12,15,10,13,8,13,9,10,16,11,13,12,15,16,12,12,11,11,13,16,12,10,14,10,14,14,16,10,12,15,9,16,13,10,12,7,11,12,12,9,6,9,10,16,10,10,16,11,9,13,16,17,14,12,8,11,9,11,13,12,11,10,12,13,14,12,16,16,9,12,13,11,15,11,10,12,8,11,9,9,14,14,12,14,13,9,12,10,14,15,14,12,8,6,11,11,9,12,14,10,9,12,13,7,13,8,14,12,12,12,13,12,10,10,13,17,11,13,13,8,13,17,13,
  14,12,15,13,11,17,11,13,13,14,14,12,14,15,11,13,14,12,16,17,13,16,17,16,15,15,13,11,17,15,14,15,14,14,8,12,11,12,14,12,16,11,9,13,10,13,10,14,12,11,8,14,14,14,12,11,16,12,9,13,10,12,15,16,10,11,13,11,13,10,15,11,10,15,13,13,13,15,16,9,17,9,12,12,12,15,17,12,15,14,14,15,13,13,11,15,14,12,13,14,13,12,13,16,11,12,15,13,14,14,11,11,12,13,16,12,10,8,10,13,15,9,12,15,13,12,12,13,16,14,12,11,10,10,14,14,13,12,12,14,13,14,13,14,14,12,15,12,13,15,12,12,12,11,14,12,11,16,15,12,16,13,11,14,11,12,14,15,14,10,8,13,15,11,14,13,13,12,12,16,11,14,10,13,15,12,14,14,15,14,12,13,17,13,13,14,10,13,19,13
),.Dim=c(N,2))


data <- list(N = N, xA = xA, xB = xB)



# ------------------------------------------------------------------------------
# Estimation by Hamilton Monte Carlo Method
# ------------------------------------------------------------------------------
scr <- ".//stan//performance_evaluation.stan"
scan(scr, what = character(), sep = "\n", blank.lines.skip = F)


par <- c("rhoA", "rhoB", "delta_r", "delta_r_over")

war <- 1000               #バーンイン期間
ite <- 11000              #サンプル数
see <- 12345              #シード
dig <- 3                  #有効数字
cha <- 1                  #チェーンの数



# ----------
fit <- stan(file = scr, data = data, iter = ite, seed = see, warmup = war, pars = par, chains = cha)



# ----------
graphics.off()
traceplot(fit, inc_warmup = F)

plot(fit)



# ----------
print(fit, pars = par, digits_summary = dig)



# ----------
# 転職群の方が、2者間の評価傾向が安定していると言えるか　（相関係数が高いと言えるか）:  EAP is larger for rhoB but the 95% credible interval is overlapped
# 2群の相関係数の差がプラスの確率は？:  96.3%


